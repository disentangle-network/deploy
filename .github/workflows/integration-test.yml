name: Integration Test

on:
  push:
    branches: [main]
  pull_request:

jobs:
  integration:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version:
          - v1.28.13
          - v1.29.8
          - v1.30.4
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Create kind cluster (K8s ${{ matrix.k8s-version }})
        uses: helm/kind-action@v1
        with:
          node_image: kindest/node:${{ matrix.k8s-version }}
          cluster_name: disentangle-test

      - name: Build test image (or use existing)
        run: |
          # For CI, we use a mock/stub image since we can't build the full Rust binary
          # In production CI, this would build from the protocol repo
          echo "Using chart default image (pull from registry)"

      - name: Install chart
        run: |
          helm install test-release helm/disentangle/ \
            --namespace disentangle --create-namespace \
            --set nodes.count=3 \
            --set pow.difficulty=8 \
            --set pow.mineIntervalSecs=5 \
            --set persistence.enabled=false \
            --set image.pullPolicy=IfNotPresent \
            --wait --timeout=300s
        # TODO: Remove continue-on-error once ghcr.io/disentangle-network/disentangle-node
        # is published. Currently soft-fails because the image doesn't exist yet.
        continue-on-error: true

      - name: Check pod status
        if: always()
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n disentangle -o wide
          echo ""
          echo "=== Pod Events ==="
          kubectl get events -n disentangle --sort-by='.lastTimestamp' | tail -20
          echo ""
          echo "=== Pod Logs (node-0) ==="
          kubectl logs test-release-disentangle-0 -n disentangle --tail=50 2>/dev/null || echo "No logs available"

      - name: Run helm tests
        run: |
          helm test test-release -n disentangle --timeout=120s
        # TODO: Remove continue-on-error once ghcr.io/disentangle-network/disentangle-node
        # is published. Helm test pods cannot start without a valid image.
        continue-on-error: true

      - name: Collect test results
        if: always()
        run: |
          echo "=== Test Pod Logs ==="
          for pod in $(kubectl get pods -n disentangle -l "helm.sh/hook=test" -o name 2>/dev/null); do
            echo "--- $pod ---"
            kubectl logs "$pod" -n disentangle 2>/dev/null || echo "No logs"
          done

      - name: Cleanup
        if: always()
        run: |
          helm uninstall test-release -n disentangle 2>/dev/null || true
