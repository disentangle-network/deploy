name: Integration Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  integration:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s-version:
          - v1.28.13
          - v1.29.8
          - v1.30.4
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Create kind cluster (K8s ${{ matrix.k8s-version }})
        uses: helm/kind-action@v1
        with:
          node_image: kindest/node:${{ matrix.k8s-version }}
          cluster_name: disentangle-test

      - name: Pull and load real image into kind
        run: |
          # Read appVersion from Chart.yaml to stay in sync with the chart.
          # Pull the platform-specific image then re-tag to strip the multi-arch
          # manifest index, which kind's containerd import cannot handle.
          APP_VERSION=$(grep '^appVersion:' helm/disentangle/Chart.yaml | sed 's/appVersion: *"\(.*\)"/\1/')
          IMAGE="ghcr.io/disentangle-network/disentangle-node:${APP_VERSION}"
          echo "Pulling ${IMAGE} (linux/amd64)"
          docker pull --platform linux/amd64 "${IMAGE}"
          IMGID=$(docker images --no-trunc -q "${IMAGE}" | head -1)
          docker tag "${IMGID}" "${IMAGE}"
          kind load docker-image "${IMAGE}" --name disentangle-test

      - name: Install chart
        run: |
          helm install test-release helm/disentangle/ \
            --namespace disentangle --create-namespace \
            --set nodes.count=3 \
            --set pow.difficulty=8 \
            --set pow.mineIntervalSecs=5 \
            --set persistence.enabled=false \
            --set image.pullPolicy=IfNotPresent \
            --wait --timeout=300s

      - name: Check pod status
        if: always()
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n disentangle -o wide
          echo ""
          echo "=== Pod Events ==="
          kubectl get events -n disentangle --sort-by='.lastTimestamp' | tail -20
          echo ""
          echo "=== Pod Logs (node-0) ==="
          kubectl logs test-release-disentangle-0 -n disentangle --tail=50 2>/dev/null || echo "No logs available"

      - name: Run helm tests
        run: |
          helm test test-release -n disentangle --timeout=120s

      - name: Collect test results
        if: always()
        run: |
          echo "=== Test Pod Logs ==="
          for pod in $(kubectl get pods -n disentangle -l "helm.sh/hook=test" -o name 2>/dev/null); do
            echo "--- $pod ---"
            kubectl logs "$pod" -n disentangle 2>/dev/null || echo "No logs"
          done

      - name: Cleanup
        if: always()
        run: |
          helm uninstall test-release -n disentangle 2>/dev/null || true
