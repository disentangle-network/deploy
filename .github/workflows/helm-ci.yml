name: Helm CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'helm/**'
      - 'gitops/**'
      - 'tests/**'
      - '.github/workflows/helm-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'helm/**'
      - 'gitops/**'
      - 'tests/**'
      - '.github/workflows/helm-ci.yml'

jobs:
  helm-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - run: helm lint helm/disentangle/

  helm-template:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Template with default values
        run: helm template test helm/disentangle/ > /dev/null
      - name: Template 3-node minimal
        run: helm template test helm/disentangle/ --set nodes.count=3 > /dev/null
      - name: Template 10-node with traffic
        run: |
          helm template test helm/disentangle/ \
            --set nodes.count=10 \
            --set traffic.enabled=true \
            --set dashboard.enabled=true > /dev/null

  kubeconform:
    runs-on: ubuntu-latest
    needs: helm-template
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz | \
            tar xz -C /usr/local/bin
      - name: Validate Kubernetes manifests
        run: |
          helm template test helm/disentangle/ | \
            kubeconform -strict -summary \
              -ignore-missing-schemas \
              -kubernetes-version 1.29.0

  kustomize-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate all overlays
        run: |
          for overlay in gitops/overlays/*/; do
            echo "=== Building $overlay ==="
            kubectl kustomize "$overlay"  > /dev/null
            echo "OK"
          done

  yamllint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install yamllint
        run: pip install yamllint
      - name: Lint YAML files
        run: |
          yamllint -d relaxed helm/disentangle/Chart.yaml helm/disentangle/values.yaml helm/disentangle/values.schema.json gitops/

  helm-unittest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Install helm-unittest
        run: helm plugin install https://github.com/helm-unittest/helm-unittest --version v0.5.2
      - name: Run unit tests
        run: helm unittest helm/disentangle/

  golden-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Verify golden files
        run: ./tests/golden/verify.sh

  policy-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Install conftest
        run: |
          curl -sL https://github.com/open-policy-agent/conftest/releases/download/v0.52.0/conftest_0.52.0_Linux_x86_64.tar.gz | \
            tar xz -C /usr/local/bin
      - name: Run OPA policy tests
        run: ./tests/policies/run-conftest.sh

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: helm-template
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Install kube-linter
        run: |
          curl -sL https://github.com/stackrox/kube-linter/releases/download/v0.6.8/kube-linter-linux.tar.gz | \
            tar xz -C /usr/local/bin
      - name: Render templates
        run: helm template test-release helm/disentangle/ > /tmp/rendered.yaml
      - name: Run kube-linter
        run: kube-linter lint --config .kube-linter.yaml /tmp/rendered.yaml
