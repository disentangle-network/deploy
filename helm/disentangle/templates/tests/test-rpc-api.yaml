apiVersion: v1
kind: Pod
metadata:
  name: {{ include "disentangle.fullname" . }}-test-rpc
  labels:
    {{- include "disentangle.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "kube-linter.io/ignore-all": "true"
spec:
  restartPolicy: Never
  containers:
  - name: test-rpc
    image: "{{ .Values.testImage.repository }}:{{ .Values.testImage.tag }}"
    imagePullPolicy: {{ .Values.testImage.pullPolicy }}
    securityContext:
      runAsNonRoot: true
      runAsUser: 65532
      allowPrivilegeEscalation: false

      capabilities:
        drop: ["ALL"]
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        cpu: 100m
        memory: 64Mi
    command:
      - /bin/sh
      - -c
      - |
        set -e

        echo "=== Disentangle RPC API Test ==="

        RPC_URL="http://{{ include "disentangle.fullname" . }}-rpc:{{ .Values.rpcService.port }}"

        echo ""
        echo "--- Test 1: GET /status ---"
        STATUS=$(curl -sf "$RPC_URL/status")
        echo "$STATUS" | jq -e '.peer_id' > /dev/null
        echo "$STATUS" | jq -e '.dag_size' > /dev/null
        echo "PASS: /status returns valid JSON with peer_id and dag_size"

        echo ""
        echo "--- Test 2: GET /graph ---"
        GRAPH=$(curl -sf "$RPC_URL/graph")
        echo "$GRAPH" | jq -e '.nodes' > /dev/null
        echo "$GRAPH" | jq -e '.edges' > /dev/null
        echo "PASS: /graph returns valid JSON with nodes and edges"

        echo ""
        echo "--- Test 3: Status fields valid ---"
        PEER_ID=$(echo "$STATUS" | jq -r '.peer_id')
        DAG_SIZE=$(echo "$STATUS" | jq -r '.dag_size')
        echo "  peer_id: $PEER_ID"
        echo "  dag_size: $DAG_SIZE"

        if [ -z "$PEER_ID" ] || [ "$PEER_ID" = "null" ]; then
          echo "FAIL: peer_id is empty"
          exit 1
        fi
        echo "PASS: All status fields valid"

        echo ""
        echo "=== RPC API test passed ==="
