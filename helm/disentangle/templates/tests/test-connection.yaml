apiVersion: v1
kind: Pod
metadata:
  name: {{ include "disentangle.fullname" . }}-test-connection
  labels:
    {{- include "disentangle.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test-connection
    image: alpine/curl:latest
    command:
      - /bin/sh
      - -c
      - |
        set -e
        echo "=== Disentangle Connection Test ==="

        RPC_SVC="{{ include "disentangle.fullname" . }}-rpc"
        RPC_PORT="{{ .Values.rpcService.port }}"
        NODE_COUNT={{ .Values.nodes.count }}
        HEADLESS_SVC="{{ include "disentangle.fullname" . }}-headless"
        NAMESPACE="{{ .Release.Namespace }}"

        echo ""
        echo "--- Test 1: RPC service reachable ---"
        STATUS=$(curl -sf "http://${RPC_SVC}:${RPC_PORT}/status")
        if [ -z "$STATUS" ]; then
          echo "FAIL: RPC service not responding"
          exit 1
        fi
        echo "PASS: RPC service responding"
        echo "Response: $(echo "$STATUS" | head -c 200)"

        echo ""
        echo "--- Test 2: Individual node health ---"
        FAILURES=0
        for i in $(seq 0 $((NODE_COUNT - 1))); do
          POD_DNS="{{ include "disentangle.fullname" . }}-${i}.${HEADLESS_SVC}.${NAMESPACE}.svc.cluster.local"
          if curl -sf "http://${POD_DNS}:${RPC_PORT}/status" > /dev/null 2>&1; then
            echo "  Node $i: OK"
          else
            echo "  Node $i: FAIL"
            FAILURES=$((FAILURES + 1))
          fi
        done

        if [ "$FAILURES" -gt 0 ]; then
          echo "FAIL: $FAILURES node(s) not responding"
          exit 1
        fi
        echo "PASS: All $NODE_COUNT nodes healthy"

        echo ""
        echo "=== Connection test passed ==="
