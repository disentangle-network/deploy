{{- if .Values.traffic.enabled -}}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "disentangle.fullname" . }}-txgen
  labels:
    {{- include "disentangle.labels" . | nindent 4 }}
    app.kubernetes.io/component: txgen
spec:
  schedule: {{ .Values.traffic.interval | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        {{- include "disentangle.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: txgen
    spec:
      template:
        metadata:
          labels:
            {{- include "disentangle.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: txgen
        spec:
          restartPolicy: OnFailure
          securityContext:
            {{- toYaml .Values.podSecurityContext | nindent 12 }}
          containers:
          - name: txgen
            image: alpine/curl:latest
            imagePullPolicy: IfNotPresent
            securityContext:
              {{- toYaml .Values.securityContext | nindent 14 }}
            command:
              - /bin/sh
              - -c
              - |
                RPC_URL="http://{{ include "disentangle.fullname" . }}-rpc:{{ .Values.rpcService.port }}"
                echo "Generating {{ .Values.traffic.txCount }} transactions to $RPC_URL"

                # Verify node is alive
                echo "Checking node status..."
                STATUS=$(curl -sf "$RPC_URL/status") || { echo "FATAL: node not reachable"; exit 1; }
                DAG_SIZE=$(echo "$STATUS" | grep -o '"dag_size":[0-9]*' | cut -d: -f2)
                echo "  dag_size=$DAG_SIZE"

                for i in $(seq 1 {{ .Values.traffic.txCount }}); do
                  # GET /tips returns full 32-byte hex tip hashes as a JSON array:
                  #   ["aabb...64chars","ccdd...64chars",...]
                  # Take up to 3 tips as parent references for the new transaction.
                  TIPS_JSON=$(curl -sf "$RPC_URL/tips") || { echo "Failed to fetch tips for tx $i"; continue; }

                  # Extract up to 3 quoted hex hashes and rebuild as a JSON array.
                  # Each element is already a quoted string, e.g. "aabb...".
                  PARENTS=$(echo "$TIPS_JSON" \
                    | tr -d '[]' \
                    | tr ',' '\n' \
                    | head -3 \
                    | tr '\n' ',' \
                    | sed 's/,$//')
                  PARENTS="[${PARENTS}]"

                  PAYLOAD="{\"sender\":\"txgen-$HOSTNAME-$i\",\"parents\":$PARENTS,\"data\":\"txgen-$(date +%s)-$i\"}"

                  echo "Submitting transaction $i (parents: $PARENTS)..."
                  RESPONSE=$(curl -sf -X POST \
                    -H "Content-Type: application/json" \
                    -d "$PAYLOAD" \
                    "$RPC_URL/transaction") || { echo "Transaction $i failed"; continue; }

                  echo "  $RESPONSE"
                  sleep 1
                done

                echo "Transaction generation complete"
{{- end }}
