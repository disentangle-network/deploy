suite: ServiceAccount tests
templates:
  - templates/serviceaccount.yaml
release:
  name: test-release
  namespace: default
tests:
  - it: should create ServiceAccount by default
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: test-release-disentangle

  - it: should not create ServiceAccount when disabled
    set:
      serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom name when provided
    set:
      serviceAccount.create: true
      serviceAccount.name: custom-sa
    asserts:
      - equal:
          path: metadata.name
          value: custom-sa

  - it: should use default fullname when custom name not provided
    set:
      serviceAccount.create: true
      serviceAccount.name: ""
    asserts:
      - equal:
          path: metadata.name
          value: test-release-disentangle

  - it: should have correct metadata labels
    set:
      serviceAccount.create: true
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: disentangle
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-release
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm
      - isNotNull:
          path: metadata.labels["helm.sh/chart"]

  - it: should only render when serviceAccount.create is true
    set:
      serviceAccount.create: true
    asserts:
      - hasDocuments:
          count: 1

  - it: should be valid ServiceAccount resource
    set:
      serviceAccount.create: true
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: apiVersion
          value: v1
