suite: StatefulSet tests
templates:
  - templates/statefulset.yaml
release:
  name: test-release
  namespace: default
tests:
  - it: should create StatefulSet with default values
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: test-release-disentangle
      - equal:
          path: spec.replicas
          value: 5
      - equal:
          path: spec.serviceName
          value: test-release-disentangle-headless

  - it: should set custom node count
    set:
      nodes.count: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should set custom node count to 10
    set:
      nodes.count: 10
    asserts:
      - equal:
          path: spec.replicas
          value: 10

  - it: should have bootstrap command for node-0 without bootstrap peer
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'if \[ "\$ORDINAL" = "0" \]; then'
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'exec disentangle-node 9000 8000\n'

  - it: should have follower command with dns4 multiaddr to node-0
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'BOOTSTRAP="test-release-disentangle-0\.test-release-disentangle-headless\.default\.svc\.cluster\.local"'
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'exec disentangle-node 9000 8000 /dns4/\$\{BOOTSTRAP\}/tcp/9000'

  - it: should include custom ports in follower command
    set:
      nodes.p2pPort: 9999
      nodes.rpcPort: 7777
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'exec disentangle-node 9999 7777\n'
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: 'exec disentangle-node 9999 7777 /dns4/\$\{BOOTSTRAP\}/tcp/9999'

  - it: should create volumeClaimTemplates when persistence enabled
    set:
      persistence.enabled: true
    asserts:
      - isNotNull:
          path: spec.volumeClaimTemplates
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: data
      - contains:
          path: spec.volumeClaimTemplates[0].spec.accessModes
          content: ReadWriteOnce
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 1Gi

  - it: should create emptyDir volume when persistence disabled
    set:
      persistence.enabled: false
    asserts:
      - isNull:
          path: spec.volumeClaimTemplates
      - contains:
          path: spec.template.spec.volumes
          content:
            name: data
            emptyDir: {}

  - it: should set custom storageClass when specified
    set:
      persistence.enabled: true
      persistence.storageClass: fast-ssd
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].spec.storageClassName
          value: fast-ssd

  - it: should set custom persistence size
    set:
      persistence.enabled: true
      persistence.size: 10Gi
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 10Gi

  - it: should use appVersion as default image tag
    chart:
      appVersion: v0.4.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/disentangle-network/disentangle-node:v0.4.0

  - it: should use custom image tag when specified
    set:
      image.tag: 1.0.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/disentangle-network/disentangle-node:1.0.0

  - it: should use custom image repository
    set:
      image.repository: myregistry.io/custom-node
      image.tag: latest
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: myregistry.io/custom-node:latest

  - it: should apply resource limits correctly
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 128Mi

  - it: should apply custom resource limits
    set:
      resources:
        limits:
          cpu: 2000m
          memory: 2Gi
        requests:
          cpu: 500m
          memory: 512Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 2000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 2Gi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 512Mi

  - it: should apply pod security context correctly
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.seccompProfile.type
          value: RuntimeDefault

  - it: should apply container security context correctly
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000

  - it: should configure liveness probe on rpc port
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /status
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: rpc
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 3

  - it: should configure readiness probe on rpc port
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /status
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: rpc
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 3

  - it: should configure container ports correctly
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: p2p
            containerPort: 9000
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: rpc
            containerPort: 8000
            protocol: TCP

  - it: should configure custom ports
    set:
      nodes.p2pPort: 9999
      nodes.rpcPort: 7777
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: p2p
            containerPort: 9999
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: rpc
            containerPort: 7777
            protocol: TCP

  - it: should apply custom nodeSelector
    set:
      nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should apply custom tolerations
    set:
      tolerations:
        - key: node.kubernetes.io/not-ready
          operator: Exists
          effect: NoExecute
          tolerationSeconds: 300
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: node.kubernetes.io/not-ready
            operator: Exists
            effect: NoExecute
            tolerationSeconds: 300

  - it: should apply custom affinity
    set:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - disentangle
              topologyKey: kubernetes.io/hostname
    asserts:
      - isNotNull:
          path: spec.template.spec.affinity.podAntiAffinity

  - it: should use correct service account name
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: test-release-disentangle

  - it: should use custom service account name
    set:
      serviceAccount.create: true
      serviceAccount.name: custom-sa
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: custom-sa

  - it: should configure volume mount and working directory
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: data
            mountPath: /data
      - equal:
          path: spec.template.spec.containers[0].workingDir
          value: /data

  - it: should have correct selector labels
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: disentangle
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: test-release

  - it: should have correct pod labels
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: disentangle
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          value: test-release

  - it: should set correct image pull policy
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should set custom image pull policy
    set:
      image.pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
